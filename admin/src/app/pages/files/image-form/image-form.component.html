<form [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-6">
  <!-- File Upload Area (only for new images) -->
  @if (!image) {
    <div class="space-y-2">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        {{ translate.instant('fileManagement.selectImage') }} <span class="text-red-500">*</span>
      </label>
      
      <!-- Drop Zone -->
      <div
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
        (click)="fileInput.click()"
        (keydown.enter)="fileInput.click()"
        (keydown.space)="fileInput.click(); $event.preventDefault()"
        tabindex="0"
        role="button"
        [attr.aria-label]="translate.instant('fileManagement.selectImage')"
        [class]="'relative border-2 border-dashed rounded-xl p-8 text-center transition-all duration-200 cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 ' + 
          (isDragging ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/20' : 'border-gray-300 dark:border-gray-600 hover:border-primary-400 hover:bg-gray-50 dark:hover:bg-gray-700/50')"
      >
        <input
          #fileInput
          type="file"
          accept="image/jpeg,image/jpg,image/png,image/webp,image/gif"
          (change)="onFileSelected($event)"
          class="hidden"
        />

        @if (previewUrl) {
          <!-- Preview -->
          <div class="relative inline-block">
            <img 
              [src]="previewUrl" 
              alt="Preview" 
              class="max-h-48 rounded-lg shadow-md mx-auto"
            />
            <button
              type="button"
              (click)="removeFile(); $event.stopPropagation()"
              class="absolute -top-2 -right-2 p-1 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-md transition-colors"
            >
              <cms-icon name="times" size="xs"></cms-icon>
            </button>
          </div>
          <p class="mt-3 text-sm text-gray-600 dark:text-gray-400">
            {{ selectedFile?.name }}
          </p>
        } @else {
          <!-- Upload Prompt -->
          <div class="space-y-3">
            <div class="mx-auto w-16 h-16 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center">
              <cms-icon name="cloud-upload" size="xl" class="text-primary-500"></cms-icon>
            </div>
            <div>
              <p class="text-gray-700 dark:text-gray-300">
                <span class="font-semibold text-primary-600 dark:text-primary-400">{{ translate.instant('fileManagement.clickToUpload') }}</span>
                {{ translate.instant('fileManagement.orDragDrop') }}
              </p>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                {{ translate.instant('fileManagement.allowedFormats') }}
              </p>
              <p class="text-xs text-gray-400 dark:text-gray-500">
                {{ translate.instant('fileManagement.maxFileSize') }}
              </p>
            </div>
          </div>
        }
      </div>
      
      @if (form.get('file')?.touched && form.get('file')?.hasError('required')) {
        <p class="text-sm text-red-500">{{ translate.instant('fileManagement.fileRequired') }}</p>
      }
    </div>
  } @else {
    <!-- Preview for existing image -->
    <div class="space-y-2">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        {{ translate.instant('fileManagement.currentImage') }}
      </label>
      <div class="flex items-center gap-4 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
        <img 
          [src]="previewUrl" 
          [alt]="image.altText || image.originalName"
          class="w-24 h-24 object-cover rounded-lg shadow-sm"
        />
        <div class="flex-1 min-w-0">
          <p class="font-medium text-gray-900 dark:text-white truncate">{{ image.originalName }}</p>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            {{ image.width }}×{{ image.height }} • {{ image.contentType }}
          </p>
        </div>
      </div>
    </div>
  }

  <!-- Upload Progress -->
  @if (isSubmitting && uploadProgress > 0 && uploadProgress < 100) {
    <div class="space-y-2">
      <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
        <span>{{ translate.instant('fileManagement.uploading') }}</span>
        <span>{{ uploadProgress }}%</span>
      </div>
      <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden">
        <div 
          class="bg-primary-500 h-2 rounded-full transition-all duration-300" 
          [style.width.%]="uploadProgress"
        ></div>
      </div>
    </div>
  }

  <!-- Alt Text -->
  <div class="space-y-2">
    <label for="altText" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
      {{ translate.instant('fileManagement.altText') }}
    </label>
    <input
      id="altText"
      type="text"
      formControlName="altText"
      [placeholder]="translate.instant('fileManagement.altTextPlaceholder')"
      class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
    />
    <p class="text-xs text-gray-500 dark:text-gray-400">
      {{ translate.instant('fileManagement.altTextHint') }}
    </p>
  </div>

  <!-- Caption -->
  <div class="space-y-2">
    <label for="caption" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
      {{ translate.instant('fileManagement.caption') }}
    </label>
    <textarea
      id="caption"
      formControlName="caption"
      rows="3"
      [placeholder]="translate.instant('fileManagement.captionPlaceholder')"
      class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors resize-none"
    ></textarea>
  </div>

  <!-- Actions -->
  <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
    <button
      type="button"
      (click)="onCancel()"
      class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors"
    >
      {{ translate.instant('common.cancel') }}
    </button>
    <button
      type="submit"
      [disabled]="form.invalid || isSubmitting"
      class="flex items-center gap-2 px-4 py-2 bg-primary-600 hover:bg-primary-700 disabled:bg-primary-400 disabled:cursor-not-allowed text-white rounded-lg transition-colors"
    >
      @if (isSubmitting) {
        <cms-icon name="spinner" size="sm" class="animate-spin"></cms-icon>
        {{ translate.instant('common.saving') }}
      } @else {
        <cms-icon name="save" size="sm"></cms-icon>
        {{ image ? translate.instant('common.save') : translate.instant('fileManagement.uploadImage') }}
      }
    </button>
  </div>
</form>
